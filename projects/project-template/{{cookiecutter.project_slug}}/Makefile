# üöÄ {{cookiecutter.project_name}} - Developer Makefile
# Modern Python development workflow with uv and quality gates

# Colors for better terminal output
CYAN := \033[36m
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
RESET := \033[0m
BOLD := \033[1m

# Project configuration
PROJECT_NAME := {{cookiecutter.project_slug}}
PYTHON_VERSION := {{cookiecutter.python_version}}
SRC_DIR := {{cookiecutter.package_name}}
TEST_DIR := tests

.PHONY: help install lint test format clean run venv dev-setup pre-commit all

# Default target
all: help

help: ## üìñ Show this help message
	@echo "$(BOLD)$(CYAN)üöÄ $(PROJECT_NAME) Development Commands$(RESET)"
	@echo ""
	@echo "$(BOLD)üèóÔ∏è  Setup & Installation:$(RESET)"
	@awk 'BEGIN {FS = ":.*##"; print ""} /^[a-zA-Z_-]+:.*?##/ { if ($$2 ~ /üèóÔ∏è|üì¶|üîß/) printf "  $(CYAN)%-15s$(RESET) %s\n", $$1, $$2 }' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(BOLD)‚úÖ Code Quality & Testing:$(RESET)"
	@awk 'BEGIN {FS = ":.*##"; print ""} /^[a-zA-Z_-]+:.*?##/ { if ($$2 ~ /‚úÖ|üß™|üîç|üõ°Ô∏è|üéØ/) printf "  $(GREEN)%-15s$(RESET) %s\n", $$1, $$2 }' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(BOLD)üèÉ Running & Development:$(RESET)"
	@awk 'BEGIN {FS = ":.*##"; print ""} /^[a-zA-Z_-]+:.*?##/ { if ($$2 ~ /üèÉ|üåê|üìö|üßπ/) printf "  $(YELLOW)%-15s$(RESET) %s\n", $$1, $$2 }' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(BOLD)üí° Quick Start:$(RESET)"
	@echo "  $(CYAN)make dev-setup$(RESET)   # Complete development environment setup"
	@echo "  $(GREEN)make check$(RESET)       # Run all quality checks quickly"
	@echo "  $(YELLOW)make run$(RESET)         # Start the agent"
	@echo ""

# =============================================================================
# üèóÔ∏è Environment Setup
# =============================================================================

venv: ## üîß Create Python virtual environment with uv
	@if [ ! -d .venv ]; then \
		echo "$(CYAN)Creating virtual environment...$(RESET)"; \
		uv venv .venv; \
		echo "$(GREEN)‚úÖ Virtual environment created at .venv$(RESET)"; \
		echo "$(YELLOW)üí° Activate with: source .venv/bin/activate$(RESET)"; \
	else \
		echo "$(GREEN)‚úÖ Virtual environment already exists$(RESET)"; \
	fi

.venv: ## üì¶ Ensure virtual environment exists
	@$(MAKE) venv

install: .venv ## üì¶ Install all dependencies (production + development + docs)
	@echo "$(CYAN)Installing dependencies (dev + docs)...$(RESET)"
	@if [ ! -f .venv/bin/ruff ]; then \
		uv sync --extra dev --extra docs; \
	else \
		echo "$(GREEN)‚úÖ Dependencies already installed$(RESET)"; \
	fi
	@echo "$(GREEN)‚úÖ All dependencies ready$(RESET)"

dev-setup: venv install pre-commit ## üèóÔ∏è Complete development environment setup
	@echo "$(GREEN)üéâ Development environment setup complete!$(RESET)"
	@echo "$(YELLOW)üí° Run 'make check' to validate your setup$(RESET)"

# =============================================================================
# ‚úÖ Code Quality & Testing
# =============================================================================

check: lint typecheck test ## üéØ Quick quality check (lint + type + test)
	@echo "$(GREEN)üéâ All quick checks passed!$(RESET)"

test: .venv ## üß™ Run all tests with pytest
	@echo "$(CYAN)Running tests...$(RESET)"
	@uv run pytest --tb=short --maxfail=3 tests
	@echo "$(GREEN)‚úÖ All tests passed$(RESET)"

test-cov: .venv ## üß™ Run tests with coverage reporting
	@echo "$(CYAN)Running tests with coverage...$(RESET)"
	@uv run pytest --cov=$(SRC_DIR) --cov-report=term-missing --cov-report=html --tb=short --maxfail=3 tests
	@echo "$(GREEN)‚úÖ Coverage report generated in htmlcov/$(RESET)"

test-watch: .venv ## üß™ Run tests in watch mode (re-run on file changes)
	@echo "$(CYAN)Starting test watch mode...$(RESET)"
	@echo "$(YELLOW)üí° Press Ctrl+C to stop$(RESET)"
	@uv run pytest-watch --clear --onpass="echo '$(GREEN)‚úÖ Tests passed$(RESET)'" --onfail="echo '$(RED)‚ùå Tests failed$(RESET)'"

lint: .venv ## üîç Run ruff linting (check only)
	@echo "$(CYAN)Linting code...$(RESET)"
	@uv run ruff check $(SRC_DIR) tests
	@echo "$(GREEN)‚úÖ Linting passed$(RESET)"

lint-fix: .venv ## üîç Run ruff linting with auto-fix
	@echo "$(CYAN)Fixing linting issues...$(RESET)"
	@uv run ruff check --fix $(SRC_DIR) tests
	@echo "$(GREEN)‚úÖ Linting issues fixed$(RESET)"

format: .venv ## üîç Format code with ruff
	@echo "$(CYAN)Formatting code...$(RESET)"
	@uv run ruff format $(SRC_DIR) tests
	@echo "$(GREEN)‚úÖ Code formatted$(RESET)"

format-check: .venv ## üîç Check code formatting (no changes)
	@echo "$(CYAN)Checking code formatting...$(RESET)"
	@uv run ruff format --check $(SRC_DIR) tests
	@echo "$(GREEN)‚úÖ Code formatting is correct$(RESET)"

typecheck: .venv ## üîç Run mypy type checking
	@echo "$(CYAN)Type checking...$(RESET)"
	@uv run mypy $(SRC_DIR) --python-version $(PYTHON_VERSION)
	@echo "$(GREEN)‚úÖ Type checking passed$(RESET)"

security: .venv ## üõ°Ô∏è Run security checks with bandit
	@echo "$(CYAN)Running security checks...$(RESET)"
	@uv run bandit -r $(SRC_DIR) -ll || echo "$(YELLOW)‚ö†Ô∏è Some security warnings found$(RESET)"
	@echo "$(GREEN)‚úÖ Security scan completed$(RESET)"

audit: .venv ## üõ°Ô∏è Check for known vulnerabilities in dependencies
	@echo "$(CYAN)Auditing dependencies...$(RESET)"
	@uv run pip-audit
	@echo "$(GREEN)‚úÖ Dependency audit completed$(RESET)"

pre-commit: .venv ## ‚úÖ Install and run pre-commit hooks
	@echo "$(CYAN)Setting up pre-commit hooks...$(RESET)"
	@uv run pre-commit install
	@echo "$(CYAN)Running pre-commit on all files...$(RESET)"
	@uv run pre-commit run --all-files
	@echo "$(GREEN)‚úÖ Pre-commit hooks setup and validated$(RESET)"

quality: lint format-check typecheck security ## ‚úÖ Run all quality checks
	@echo "$(GREEN)üèÜ All quality checks passed!$(RESET)"

# =============================================================================
# üèÉ Running & Development
# =============================================================================

run: .venv ## üèÉ Run the {{cookiecutter.project_name}}
	@echo "$(CYAN)Starting {{cookiecutter.project_name}}...$(RESET)"
	@echo "$(YELLOW)üí° Press Ctrl+C to stop$(RESET)"
	@uv run python run_agent.py

adk-web: .venv ## üåê Launch ADK web interface
	@echo "$(CYAN)Starting ADK web interface...$(RESET)"
	@echo "$(YELLOW)üí° Open your browser to the displayed URL$(RESET)"
	@uv run adk web

debug: .venv ## üèÉ Run agent in debug mode with verbose output
	@echo "$(CYAN)Starting agent in debug mode...$(RESET)"
	@DEBUG=true uv run python run_agent.py

shell: .venv ## üèÉ Start interactive Python shell with project loaded
	@echo "$(CYAN)Starting interactive shell...$(RESET)"
	@echo "$(YELLOW)üí° Project modules are available for import$(RESET)"
	@uv run python -i -c "from {{cookiecutter.package_name}} import *; print('{{cookiecutter.project_name}} modules loaded')"

# =============================================================================
# üìö Documentation & Utilities
# =============================================================================

docs: .venv ## üìö Generate documentation with Sphinx
	@echo "$(CYAN)Generating documentation...$(RESET)"
	@uv run sphinx-build -b html docs docs/_build/html
	@echo "$(GREEN)‚úÖ Documentation generated in docs/_build/html/$(RESET)"

docs-serve: docs ## üìö Generate and serve documentation locally
	@echo "$(CYAN)Serving documentation at http://localhost:8000$(RESET)"
	@echo "$(YELLOW)üí° Press Ctrl+C to stop$(RESET)"
	@cd docs/_build/html && python -m http.server 8000

status: .venv ## üìö Show project status and health check
	@echo "$(BOLD)$(CYAN)üîç $(PROJECT_NAME) Status$(RESET)"
	@echo ""
	@echo "$(BOLD)Python Environment:$(RESET)"
	@uv run python --version
	@echo "Virtual env: $$(pwd)/.venv"
	@echo ""
	@echo "$(BOLD)Dependencies:$(RESET)"
	@uv run pip list | grep -E "(ruff|pytest|mypy|google-adk)" || echo "Core dependencies not found"
	@echo ""
	@echo "$(BOLD)Project Structure:$(RESET)"
	@ls -la $(SRC_DIR)/ | head -5
	@echo ""
	@echo "$(BOLD)Last Commit:$(RESET)"
	@git log --oneline -1 2>/dev/null || echo "Not a git repository"
	@echo ""
	@echo "$(BOLD)Quick Health Check:$(RESET)"
	@echo -n "Configuration: "
	@uv run python -c "from {{cookiecutter.package_name}}.config import Config; print('‚úÖ OK' if Config.is_configured() else '‚ö†Ô∏è  Needs setup')" 2>/dev/null || echo "‚ùå Error"

# =============================================================================
# üßπ Cleanup & Maintenance
# =============================================================================

clean: ## üßπ Remove build artifacts and cache files
	@echo "$(CYAN)Cleaning up...$(RESET)"
	@rm -rf __pycache__ $(SRC_DIR)/__pycache__ $(TEST_DIR)/__pycache__
	@find . -type d -name '*.egg-info' -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name '.pytest_cache' -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name '.mypy_cache' -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name '.ruff_cache' -exec rm -rf {} + 2>/dev/null || true
	@rm -rf htmlcov coverage.xml .coverage
	@rm -rf docs/_build
	@echo "$(GREEN)‚úÖ Cleanup completed$(RESET)"

clean-all: clean ## üßπ Remove everything including virtual environment
	@echo "$(YELLOW)‚ö†Ô∏è  This will remove the virtual environment!$(RESET)"
	@read -p "Are you sure? (y/N) " -n 1 -r; echo; if [[ $$REPLY =~ ^[Yy]$$ ]]; then rm -rf .venv; echo "$(GREEN)‚úÖ Virtual environment removed$(RESET)"; else echo "$(YELLOW)Cancelled$(RESET)"; fi

reset: clean-all dev-setup ## üßπ Complete reset: clean everything and rebuild
	@echo "$(GREEN)üéâ Project reset completed!$(RESET)"

# =============================================================================
# üöÄ Advanced Development Commands
# =============================================================================

ci: ## üéØ Run full CI pipeline locally
	@echo "$(BOLD)$(CYAN)üöÄ Running full CI pipeline...$(RESET)"
	@echo ""
	@echo "$(CYAN)1/5 - Linting...$(RESET)"
	@$(MAKE) lint
	@echo ""
	@echo "$(CYAN)2/5 - Type checking...$(RESET)"
	@$(MAKE) typecheck
	@echo ""
	@echo "$(CYAN)3/5 - Testing...$(RESET)"
	@$(MAKE) test-cov
	@echo ""
	@echo "$(CYAN)4/5 - Security scan...$(RESET)"
	@$(MAKE) security
	@echo ""
	@echo "$(CYAN)5/5 - Dependency audit...$(RESET)"
	@$(MAKE) audit
	@echo ""
	@echo "$(BOLD)$(GREEN)üèÜ Full CI pipeline completed successfully!$(RESET)"

benchmark: .venv ## üéØ Run performance benchmarks
	@echo "$(CYAN)Running performance benchmarks...$(RESET)"
	@uv run python -m pytest tests/ -k "performance" -v --tb=short
	@echo "$(GREEN)‚úÖ Benchmarks completed$(RESET)"

fix: .venv ## üîß Auto-fix all fixable issues (format + lint-fix)
	@echo "$(CYAN)Auto-fixing all issues...$(RESET)"
	@$(MAKE) format
	@$(MAKE) lint-fix
	@echo "$(GREEN)‚úÖ Auto-fixes applied$(RESET)"

outdated: .venv ## üì¶ Check for outdated dependencies
	@echo "$(CYAN)Checking for outdated dependencies...$(RESET)"
	@uv run pip list --outdated

update-deps: .venv ## üì¶ Update all dependencies to latest versions
	@echo "$(YELLOW)‚ö†Ô∏è  This will update all dependencies!$(RESET)"
	@read -p "Continue? (y/N) " -n 1 -r; echo; if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "$(CYAN)Updating dependencies...$(RESET)"; \
		uv pip install --upgrade pip --python .venv/bin/python; \
		uv pip install --upgrade -e . --python .venv/bin/python; \
		echo "$(GREEN)‚úÖ Dependencies updated$(RESET)"; \
	else \
		echo "$(YELLOW)Cancelled$(RESET)"; \
	fi
